{
  "hash": "1523deaab2b1f49dddabc799d8b1f762",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"6: Clustering Analysis for Audit Risk Detection\"\ndate: today\nexecute: \n  eval: false #set to true\n  message: false\n  warning: false\n---\n\n## Executive Summary\n\n*Write a 2-3 sentence summary of your clustering analysis and the highest-risk expense patterns identified. Complete this section after finishing the assignment.*\n\n---\n\n## Introduction\n\nAs an accounting professional performing audit procedures, you need to identify unusual patterns and potential anomalies in expense data. Clustering analysis helps auditors:\n\n- Group similar transactions to identify outliers\n- Detect expense patterns that deviate from normal behavior\n- Prioritize high-risk transactions for detailed review\n- Improve audit efficiency through data-driven sampling\n\nIn this blog post, you will:\n\n- Apply k-means clustering to expense report data\n- Visualize clusters to identify unusual patterns\n- Analyze cluster characteristics for audit risk indicators\n- Recommend transactions for further investigation\n\n## Setup and Load Libraries\n\n### Required Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load packages we need - matching the slides\nlibrary(tidyverse)    # For data manipulation\nlibrary(tidymodels)   # For clustering\nlibrary(tidyclust)    # Additional clustering tools\nlibrary(scales)       # For formatting numbers\nlibrary(gt)           # For nice tables\nlibrary(patchwork)    # For combining multiple plots\n\n# Set preferences\ntheme_set(theme_minimal())  # Clean plots\noptions(scipen = 999)       # No scientific notation\nset.seed(2027)              # Reproducible results\n```\n:::\n\n\n### Load and Explore the Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the expense report data\nexpense_reports <- read_csv(\"expense_reports.csv\")\n# TODO: fix path after loaded on web\n# Display structure of the data\nglimpse(expense_reports)\n\n# View first few rows\nhead(expense_reports)\n\n# Basic summary statistics\nsummary(expense_reports)\n```\n:::\n\n\n## Initial Data Exploration\n\n### Expense Distribution Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualize expense amount distribution\nexpense_reports |>\n  ggplot(aes(x = amount)) +\n  geom_histogram(bins = 50, fill = \"steelblue\") +\n  scale_x_continuous(labels = dollar_format()) +\n  labs(\n    title = \"Distribution of Expense Amounts\",\n    subtitle = \"Most expenses cluster at lower amounts with some outliers\",\n    x = \"Expense Amount\",\n    y = \"Count\"\n  )\n\n# Check for potential red flags\nred_flags_summary <- expense_reports |>\n  summarize(\n    total_expenses = n(),\n    weekend_expenses = sum(_____),  # Count weekend expenses\n    round_amounts = sum(_____),     # Count round amounts\n    high_amounts = sum(_____),      # Count high amounts\n    delayed_submissions = sum(_____) # Count delayed submissions\n  )\n\n# Display red flags summary using gt\nred_flags_summary |>\n  pivot_longer(everything(), names_to = \"Metric\", values_to = \"Count\") |>\n  gt() |>\n  tab_header(title = \"Expense Report Red Flags Summary\")\n```\n:::\n\n\n### Expense Patterns by Department\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Summarize by department\ndept_summary <- expense_reports |>\n  group_by(_____) |>  # Group by department\n  summarize(\n    expense_count = n(),\n    total_amount = sum(_____),\n    avg_amount = mean(_____),\n    weekend_pct = mean(_____),\n    round_amount_pct = mean(_____) \n  ) |>\n  arrange(desc(total_amount))\n\n# Display department summary using gt\ndept_summary |>\n  mutate(\n    total_amount = dollar(total_amount, accuracy = 1),\n    avg_amount = dollar(avg_amount, accuracy =1),\n    weekend_pct = percent(weekend_pct, accuracy = 1),\n    round_amount_pct = percent(round_amount_pct, accuracy = 1)\n  ) |>\n  gt() |>\n  tab_header(title = \"Department Expense Analysis\")\n\n# Visualize department spending\ndept_summary |>\n  ggplot(aes(x = total_amount, y = reorder(department, total_amount))) +\n  geom_col(fill = \"darkblue\") +\n  scale_x_continuous(labels = _____) +  # Format as currency\n  labs(\n    title = \"Total Expenses by Department\",\n    x = NULL,\n    y = NULL\n  )\n```\n:::\n\n\n## Data Preparation \n\nPrepare the data for clustering by selecting and scaling variables (following the slides approach).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Select features for clustering\n# Document why you chose these features\nclustering_features <- expense_reports |>\n  select(\n    _____,                    # Transaction amount - consider log transform\n    _____,                    # Days to submit\n    _____,                    # Weekend indicator (0/1)\n    _____,                    # Round amount flag (0/1)\n    _____,                    # Multiple expenses same day\n    _____                     # Employee's average expense\n  )\n\n# Add log transformation for amount if needed\nclustering_features <- clustering_features |>\n  mutate(log_amount = log(amount + 1)) |>  # Add 1 to handle any zeros\n  select(-amount)  # Remove original amount\n\n# Scale the features (following slides approach)\nclustering_data <- clustering_features |>\n  mutate(\n    log_amount_scaled = scale(log_amount)[,1],\n    submission_delay_scaled = scale(_____)[,1],\n    is_weekend_scaled = _____,               # Binary - keep as is\n    is_round_amount_scaled = _____,          # Binary - keep as is\n    same_day_expense_count_scaled = scale(_____)[,1],\n    employee_avg_amount_scaled = scale(_____)[,1]\n  ) |>\n  select(ends_with(\"_scaled\"))\n\n# Check your work\nclustering_data |> summary()\n```\n:::\n\n\n## K-means Clustering Analysis\n\n### Step 1: Set Up K-Means Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Specify the k-means model with 3 clusters (following slides)\nkmeans_spec <- k_means(num_clusters = _____) |>  # Use 3 clusters\n  set_engine(\"stats\")\n\n# View the model specification\nkmeans_spec\n```\n:::\n\n\n### Step 2: Fit the Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit the model to our prepared data\nkmeans_fit <- kmeans_spec |>\n  fit(~ ., data = _____)  # Fit to all variables in clustering_data\n```\n:::\n\n\n### Step 3: Extract Cluster Assignments\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get cluster assignments\ncluster_assignments <- kmeans_fit |>\n  extract_cluster_assignment()\n\n# View the assignments\nhead(cluster_assignments)\n\n# Add clusters to original data\nexpense_reports_clustered <- expense_reports |>\n  bind_cols(cluster_assignments)\n\n# Check the results\nexpense_reports_clustered |>\n  select(expense_id, amount, submission_delay, is_weekend, .cluster) |>\n  head(10)\n```\n:::\n\n\n## Visualizing Clusters\n\n### Visualization 1: Amount vs Submission Delay\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create scatter plot colored by cluster\nexpense_reports_clustered |>\n  ggplot(aes(x = submission_delay, y = amount, color = .cluster)) +\n  geom_point(alpha = 0.6, size = 2) +\n  scale_y_continuous(labels = dollar_format()) +\n  scale_color_manual(\n    values = c(\"Cluster_1\" = \"orange\", \"Cluster_2\" = \"red\", \"Cluster_3\" = \"green\")\n  ) +\n  labs(\n    title = \"Expense Clusters: Amount vs Submission Delay\",\n    x = \"Days to Submit\",\n    y = \"Expense Amount\",\n    color = NULL \n  )\n```\n:::\n\n\n### Visualization 2: Box Plots by Cluster\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create box plots of amount by cluster\nexpense_reports_clustered |>\n  ggplot(aes(x = .cluster, y = amount, fill = .cluster)) +\n  geom______() +\n  scale_y_continuous(labels = dollar_format()) +\n  scale_fill_manual(\n    values = c(\"Cluster_1\" = \"orange\", \"Cluster_2\" = \"red\", \"Cluster_3\" = \"green\")\n  ) +\n  labs(\n    title = \"Expense Amount Distribution by Cluster\",\n    x = \"Cluster\",\n    y = \"Amount\"\n  ) +\n  theme(legend.position = \"none\")\n```\n:::\n\n\n## Cluster Analysis and Risk Assessment\n\n### Step 4: Analyze Cluster Characteristics\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate detailed statistics for each cluster\ncluster_profiles <- expense_reports_clustered |>\n  group_by(_____) |>  # Group by cluster\n  summarize(\n    transaction_count = n(),\n    avg_amount = mean(amount),\n    max_amount = max(amount),\n    avg_submission_delay = mean(submission_delay),\n    weekend_pct = mean(is_weekend),\n    round_amount_pct = mean(is_round_amount),\n    high_amount_pct = mean(is_high_amount),\n    multiple_same_day_pct = mean(multiple_same_day),\n    unique_employees = n_distinct(employee_id),\n    unique_vendors = n_distinct(vendor)\n  )\n\n# Display cluster profiles using gt\ncluster_profiles |>\n  mutate(\n    avg_amount = dollar(avg_amount),\n    max_amount = dollar(max_amount),\n    weekend_pct = percent(weekend_pct),\n    round_amount_pct = percent(round_amount_pct),\n    high_amount_pct = percent(high_amount_pct),\n    multiple_same_day_pct = percent(multiple_same_day_pct)\n  ) |>\n  gt() |>\n  tab_header(title = \"Cluster Characteristics Analysis\")\n```\n:::\n\n\n### Step 5: Identify High-Risk Cluster\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add risk scoring (following slides approach)\ncluster_profiles <- cluster_profiles |>\n  mutate(\n    risk_score = (avg_amount / max(avg_amount)) * _____ +     # Amount (40% weight)\n                 ((50 - avg_submission_delay) / 50) * _____ + # Speed (30% weight)  \n                 weekend_pct * _____ +                        # Weekend (20% weight)\n                 round_amount_pct * _____                     # Round amounts (10% weight)\n  ) |>\n  arrange(desc(risk_score)) |>\n  mutate(risk_level = c(\"High Risk\", \"Medium Risk\", \"Low Risk\"))\n\n# Display risk-scored clusters\ncluster_profiles |>\n  select(.cluster, risk_score, risk_level, transaction_count, avg_amount) |>\n  mutate(avg_amount = dollar(avg_amount)) |>\n  gt() |>\n  tab_header(title = \"Cluster Risk Assessment\")\n\n# Get highest risk cluster\nhigh_risk_cluster <- cluster_profiles |>\n  filter(risk_level == \"High Risk\") |>\n  pull(.cluster)\n```\n:::\n\n\n### Step 6: Apply Risk Classifications\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create risk mapping\ncluster_risk_mapping <- cluster_profiles |>\n  select(.cluster, risk_level)\n\n# Apply risk labels to all transactions\nexpense_reports_clustered <- expense_reports_clustered |>\n  left_join(cluster_risk_mapping, by = \"i.cluster\")\n\n# View high-risk transactions\nhigh_risk_expenses <- expense_reports_clustered |>\n  filter(risk_level == \"High Risk\") |>\n  arrange(desc(amount))\n\n# Display top 10 high-risk expenses\nhigh_risk_expenses |>\n  select(expense_id, employee_id, department, vendor, amount, \n        expense_date, is_weekend, is_round_amount) |>\n  head(10) |>\n  mutate(amount = dollar(amount)) |>\n  gt() |>\n  tab_header(title = \"Top 10 High-Risk Expenses\")\n```\n:::\n\n\n## Audit Planning 📝\n\nUse clustering results to create an audit plan.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Analyze high-risk cluster for audit planning\naudit_focus <- expense_reports_clustered |>\n  filter(.cluster == _____) |>  # Use high_risk_cluster\n  summarise(\n    transaction_count = _____,\n    total_value = sum(_____),\n    vendors_affected = n_distinct(_____),\n    departments_affected = n_distinct(_____),\n    avg_amount = mean(_____)\n  )\n\n# Format and display results\naudit_focus |>\n  mutate(\n    total_value = dollar(total_value),\n    avg_amount = dollar(avg_amount)\n  ) |>\n  gt() |>\n  tab_header(title = \"High-Risk Cluster Analysis for Audit Planning\")\n\n# Create audit recommendations\naudit_recommendations <- tribble(\n  ~Area, ~Finding, ~Recommendation,\n  \"Scope\", paste(_____, \"high-risk transactions identified\"), \n  \"Perform detailed testing on all high-risk transactions\",\n  \"Materiality\", paste(\"Total value:\", dollar(_____)),\n  \"Focus on transactions over $_____\",\n  \"Vendors\", paste(_____, \"vendors in high-risk cluster\"),\n  \"Review vendor approval and payment processes\"\n)\n\naudit_recommendations |>\n  gt() |>\n  tab_header(title = \"Audit Planning Recommendations\")\n```\n:::\n\n\n## Visualization Summary Dashboard\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create summary metrics following slides approach\nlibrary(patchwork)\n\n# Risk indicators by cluster  \np1 <- cluster_profiles |>\n  select(.cluster, weekend_pct, round_amount_pct, high_amount_pct) |>\n  pivot_longer(-.cluster, names_to = \"indicator\", values_to = \"percentage\") |>\n  mutate(\n    indicator = case_when(\n      indicator == \"weekend_pct\" ~ \"Weekend\",\n      indicator == \"round_amount_pct\" ~ \"Round Amount\", \n      indicator == \"high_amount_pct\" ~ \"High Amount\"\n    )\n  ) |>\n  ggplot(aes(x = indicator, y = percentage, fill = .cluster)) +\n  geom_col(position = \"dodge\") +\n  scale_fill_manual(\n    values = c(\"Cluster_1\" = \"green\", \"Cluster_2\" = \"orange\", \"Cluster_3\" = \"red\")\n  ) +\n  scale_y_continuous(labels = percent) +\n  labs(\n    title = \"Risk Indicators by Cluster\",\n    x = NULL,\n    y = \"Percentage\",\n    fill = \"Cluster\"\n  )\n\n# Department distribution in high-risk cluster\np2 <- expense_reports_clustered |>\n  filter(.cluster == high_risk_cluster) |>\n  count(department) |>\n  ggplot(aes(x = reorder(department, n), y = n)) +\n  geom_col(fill = \"darkred\") +\n  coord_flip() +\n  labs(\n    title = \"High-Risk Expenses by Department\",\n    x = NULL,\n    y = \"Count\"\n  )\n\n# Combine plots\np1 / p2\n```\n:::\n\n\n## Key Findings and Recommendations\n\nBased on the clustering analysis, complete these insights:\n\n1. **Cluster Identification**: Cluster _____ was identified as the highest risk with _____ expenses totaling $_____.\n\n2. **Risk Indicators**: This cluster showed:\n\n- _____% weekend expenses (vs. _____% overall average)\n- _____% round dollar amounts (potential red flag)\n- Average submission delay of _____ days\n- _____% of expenses from same-day multiple submissions\n\n3. **Department Focus**: The _____ and _____ departments had the most high-risk expenses.\n\n4. **Audit Recommendations**:\n\n- Perform detailed review of all expenses over $_____ in the high-risk cluster\n- Investigate employees with multiple same-day expenses\n- Review weekend expense policies, especially for _____ department\n- Implement controls for expenses with submission delays over _____ days\n\n5. **Estimated Audit Coverage**: By focusing on the high-risk cluster, auditors can review _____% of expenses by count while covering _____% of total expense value.\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}